## Lab Information

**Topic:** API testing

**Difficulty:** Practitioner

## Lab Description

The lab contains an online shop with a hidden API endpoint that can directly modify product pricing. Although the UI only allows normal cart operations (view product, add to cart, buy), an unused backend API endpoint exists which accepts write operations. The goal is to exploit this endpoint to change the price of the *Lightweight l33t Leather Jacket* to zero and purchase it for free.

## Vulnerability Analysis

This lab revolves around **Insecure Direct Object Access (IDOR) / Unprotected API endpoint** combined with **Missing Access Controls**.

The `/api/products/{id}/price` endpoint is intended to return the product price via **GET**, but the backend also accepts **PATCH** requests without authentication or authorization checks. Since no server-side validation restricts who can update product information, an attacker can modify critical business logic data-specifically prices.

The vulnerability manifests because:

- The endpoint is discoverable through normal browsing (price lookup).
- It supports unintended HTTP methods (PATCH).
- The server blindly trusts client-supplied JSON input.
- No authentication, role checks, or server-side price validation exists.

## Exploitation Steps

1. Visit a product page and observe browser behaviour in the dev tools network tab.
2. Identify a suspicious API call:
    
    `GET /api/products/1/price` 
    
3. Test whether the endpoint accepts other HTTP methods.
4. Send a `PATCH request to /api/products/1/price` with JSON body (add `Content-Type: application/json` header):
`{"price": 0}`
5. Confirm the price is now updated to 0.
6. Add the *Lightweight l33t Leather Jacket* to the cart.
7. Proceed to checkout and purchase it for free.

## AppSec Perspective

### **What the underlying code might look like**

A simplified backend implementation might resemble:

```jsx
// Express.js pseudo-code
app.get('/api/products/:id/price', (req, res) => {
    const product = db.getProduct(req.params.id);
    res.json({ price: product.price });
});

app.patch('/api/products/:id/price', (req, res) => {
    const id = req.params.id;
    const newPrice = req.body.price;

    // NO authentication  
    // NO authorization  
    // NO input validation  
    // Direct update of sensitive field  
    db.updateProductPrice(id, newPrice);

    res.json({ status: "updated" });
});
```

### **Security issues enabling exploitation**

- **No authentication required**
    
    Anyone on the Internet can access the endpoint.
    
- **No authorization checks**
    
    A pricing change is a privileged action but is available to everyone.
    
- **Missing HTTP method restrictions**
    
    The route allows PATCH simply because the developer didnâ€™t restrict it.
    
- **No server-side input validation**
    
    Attackers can submit arbitrary values (0, negative amounts, huge numbers).
    

### **How to fix it**

**Require authentication**

Only logged-in admin users should access pricing modification operations.

**Enforce strict authorization**

```jsx
if (!user.isAdmin) return res.status(403).json({ error: "Forbidden" });
```

**Restrict allowed HTTP methods**

Use a read-only endpoint for public users:

```jsx
app.get('/api/products/:id/price', ...);
// No PATCH route for non-admin users
```

**Validate server-side input**
Public API:

```jsx
GET /api/products/:id/price
```

Admin API (protected):

```jsx
PATCH /admin/products/:id/price
```
