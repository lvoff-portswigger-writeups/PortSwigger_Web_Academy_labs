## Lab Information

**Topic:** API testing

**Difficulty: Apprentice**

## Lab Description

This lab presents a web application with an exposed API that includes undocumented administrative-like endpoints. The API documentation is unintentionally published at `/api/`, revealing sensitive functionality.

The task is to leverage this exposed documentation to perform unauthorized user deletion. By discovering the `DELETE /api/user/[username]` endpoint, the attacker can remove the user **carlos** and solve the lab.

## Vulnerability Analysis

The vulnerability showcased here is **Exposed API Documentation / Unprotected Administrative Endpoints**, which is a combination of:

- **Broken Access Control**
- **Insecure API Discovery**
- **Lack of Authorization Checks**

The API documentation reveals endpoints such as:

`GET /user/[username]`
`PATCH /user/[username]`
`DELETE /user/[username]`

![image.png](attachment:cac447bb-7a70-40b9-9c5c-14b46fab49c4:image.png)

These endpoints are available without proper access control. The attacker, authenticated only as a normal user (`wiener`), can invoke a privileged administrative operation: deleting another user.

## Exploitation Steps

1. Logged in as `wiener:peter`.
2. Triggered the "change email" functionality.
→ Observed this request:`PATCH /api/user/wiener`
with JSON body containing the new email.
3. Requested the API root to inspect documentation:`GET /api/`
4. The response revealed available endpoints, including:
    - `GET /user/[username]`
    - `PATCH /user/[username]`
    - `DELETE /user/[username]`
5. Sent:`DELETE /api/user/carlos`
6. User **carlos** was deleted.
7. Lab solved.

## AppSec Perspective

### **What the underlying code might look like**

A simplified backend implementation might resemble:

```python
# Flask-style pseudo-code

@app.route("/api/user/<username>", methods=["GET", "PATCH", "DELETE"])
def user_handler(username):
    if request.method == "GET":
        return db.get_user(username)

    if request.method == "PATCH":
        # Update user email
        db.update_user(username, request.json.get("email"))
        return {"status": "updated"}

    if request.method == "DELETE":
        # ❌ No authorization checks!
        db.delete_user(username)
        return {"status": "deleted"}
```

### **Security Issues**

- **No authentication check on DELETE endpoint**
- **No authorization**
any user can delete any other user
- **API documentation exposed to non-admin users**
- **Single handler for all methods increases attack surface**
- **No role-based access control (RBAC)**

### **How to Fix It**

**Add authentication + authorization**

```python
if not current_user.is_authenticated:
    return {"error": "Unauthorized"}, 401

if not current_user.is_admin:
    return {"error": "Forbidden"}, 403
```

**Hide API documentation behind admin login**

Documentation endpoints must require admin authentication:

- /api/docs
- /swagger-ui
- /openapi.json

**Split admin vs user routes**

```python
/api/user/<username>        → Self-service only
/api/admin/user/<username>  → Admin-only actions (delete, modify role, etc.)
```

**Implement RBAC**

```python
if request.method == "DELETE" and not current_user.is_admin:
    return {"error": "Forbidden"}, 403
```
## References

Links to relevant documentation, PortSwigger articles, or related resources.

[Detailed Walkthrough](https://www.notion.so/Detailed-Walkthrough-2b00cb27ce70804fb4f0c239f0d36a99?pvs=21)

