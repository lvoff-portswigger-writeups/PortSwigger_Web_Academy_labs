## Lab Information

**Topic:** API testing

**Difficulty:** Practitioner

## Lab Description

This lab demonstrates **server-side parameter pollution (SSPP)** via query string manipulation. A password‑reset functionality exists at `/forgot-password`, which internally forwards parameters to another server‑side API. By injecting encoded characters (`%26` for `&`, `%23` for `#`) into the `username` parameter, an attacker can manipulate the server‑side query string, discover internal parameter names, extract the administrator's reset token, reset their password, log in as administrator, and delete **carlos**.

## Vulnerability Analysis

The vulnerability is **Server-Side Parameter Pollution in a Query String**, caused by:

- The backend forwarding user input to an internal API query string without sanitization.
- URL-encoded `&` being decoded server‑side and treated as new parameters.
- URL-encoded `#` truncating the resulting query.
- Error messages leaking internal parameter names.
- Missing validation and normalization of forwarded parameters.

This enables an attacker to inject new parameters (`field=email`, `field=reset_token`) and retrieve sensitive internal data such as the administrator's reset token.

## Exploitation Steps

1. Identified candidate endpoints with manipulable parameters:
    - `GET /product?productId=1`
    - `POST /login`
    - `POST /forgot-password`
2. Noted that `/forgot-password` behaved differently when injecting encoded characters.
3. Tested encoded ampersand (`%26`):
    
    ```
    username=administrator%26x=y
    ```
    
    → Error: *Parameter is not supported*
    Confirmed server interprets `&x=y` as a real parameter.
    
4. Tested encoded hash (`%23`):
    
    ```
    username=administrator%23
    ```
    
    → Error: *Field not specified*
    Confirmed server internally appends a `field` parameter.
    
5. Injected a new `field` parameter:
    
    ```
    username=administrator%26field=a%23
    ```
    
    → Error: *Invalid field*
    Confirmed `field` parameter exists server‑side.
    
6. Bruteforced possible field names using Intruder:
    
    ```
    username=administrator%26field=§a§%23
    ```
    
    → Discovered `email` and `username` are valid fields.
    
7. Found the client‑side JS `/static/js/forgotPassword.js` (either in History tab or page source), which included:
    
    ```
    /forgot-password?reset_token=${resetToken}
    ```
    
8. Injected `reset_token` as the field:
    
    → Server returned admin's password reset token.
    
9. Navigated to:
    
    ```
    /forgot-password?reset_token=<token>
    ```
    
    Set a new password.
    
10. Logged in as **administrator**.
11. Deleted **carlos** via admin panel.

## AppSec Perspective

### **What the underlying code might be**

A simplified backend implementation might look like:

```python
# Pseudo-code for vulnerable password reset logic

@app.post("/forgot-password")
def forgot_password():
    username = request.form.get("username")  # e.g. "administrator%26field=email%23"

    # ! Forwarded directly to internal API !
    internal_url = f"https://internal/reset?username={username}&field=email"

    # Internal server interprets:
    # &field=email added by attacker as a real parameter
    response = requests.get(internal_url)

    return response.text
```

### **Security issues enabling exploitation**

- No normalization of input (`%26`, `%23` decoded server-side)
- User input injected into server-side query string
- Error messages reveal internal details
- Reset tokens retrievable without authentication
- Missing rate-limiting on brute‑forcing field names

### **How to fix it**

**Strict input normalization**

Decode then re‑encode, collapsing dangerous characters.

**Use proper server-side parameter binding**

```python
params = {"username": clean_username}
requests.get(internal_api, params=params)
```

**Never forward raw user input into internal API URLs.**

tbd

**Validate allowed parameter names strictly**

```python
if username not in allowed_usernames:
    return error
```

**Remove verbose internal error messages.**

tbd

**Protect password reset token generation**

- Token must be sent only to the correct email.
- Must require proof of ownership before token retrieval.
