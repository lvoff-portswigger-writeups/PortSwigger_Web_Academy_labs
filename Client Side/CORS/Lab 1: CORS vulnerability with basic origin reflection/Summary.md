# Lab 1: CORS vulnerability with basic origin reflection

## Lab Information

**Topic:** Cross-origin resource sharing (CORS)

**Difficulty:** Apprentice

## Lab Description

The application exposes an endpoint `/accountDetails` that returns sensitive information, including the authenticated user's API key. The server is configured with an insecure CORS policy that reflects arbitrary Origin headers and allows credentialed cross-origin requests. This configuration enables unauthorized domains to read sensitive responses when the victim is authenticated. The objective is to retrieve the administrator’s API key by exploiting this trust relationship.

## Vulnerability Analysis

It can be observed that the server reflects any supplied Origin value in the `Access-Control-Allow-Origin` response header while also returning `Access-Control-Allow-Credentials: true`. This combination permits browsers to include session cookies in cross-origin requests and expose the response body to malicious origins. As a result, sensitive data such as the administrator’s API key can be retrieved via a malicious script hosted on an attacker-controlled domain.

## Exploitation Steps

1. Identify the injection point. The `/accountDetails` endpoint returns sensitive data and includes permissive CORS headers.
2. Test for vulnerability. The Origin header is modified to an arbitrary domain, and the server reflects it in `Access-Control-Allow-Origin` together with `Access-Control-Allow-Credentials: true`.
3. Craft the payload and execute the attack. A malicious JavaScript payload is hosted on the exploit server, issuing a credentialed XMLHttpRequest to `/accountDetails` and exfiltrating the response to the attacker-controlled endpoint.
4. Verify successful exploitation. The exploit server access log displays the administrator’s API key within the exfiltrated response.

## AppSec Perspective

### **What the underlying code might be**

A simplified backend implementation might look like:

```python
origin = request.headers.get("Origin")
response.headers["Access-Control-Allow-Origin"] = origin
response.headers["Access-Control-Allow-Credentials"] = "true"
```

### **Security issues enabling exploitation**

- Dynamic reflection of arbitrary Origin headers
- Credentialed cross-origin requests enabled for untrusted origins
- Exposure of sensitive data via CORS-accessible endpoints

### **How to fix it**

- Implement a strict allowlist of trusted origins
- Avoid reflecting arbitrary Origin values
- Disable `Access-Control-Allow-Credentials` unless strictly required
- Restrict sensitive endpoints from cross-origin access

## Key Takeaways

### Attacker perspective

- Misconfigured CORS enables authenticated data exfiltration
- Credentialed requests significantly increase impact severity

### AppSec (defender) perspective

- CORS policies must follow least-privilege principles
- Sensitive endpoints should not be exposed to cross-origin reads

## References

- https://portswigger.net/web-security/cors
- https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny
- https://cheatsheetseries.owasp.org/cheatsheets/CORS_Configuration_Cheat_Sheet.html
- https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS