# Lab 2: CORS vulnerability with trusted null origin

## Lab Information

**Topic:** Cross-origin resource sharing (CORS)

**Difficulty:** Apprentice

## Lab Description

The application exposes sensitive account information via `/accountDetails` that returns sensitive information and trusts the `null` origin in its CORS configuration. This misconfiguration allows sandboxed or file-based contexts to access credentialed responses (enables unauthorized domains to read sensitive responses when the victim is authenticated). The objective is to retrieve the administrator’s API key by exploiting this trust relationship.

## Vulnerability Analysis

It can be observed that when the Origin header is set to `null`, the server responds with `Access-Control-Allow-Origin: null` and `Access-Control-Allow-Credentials: true`. Browsers treat sandboxed iframes and certain local contexts as having a `null` origin. Trusting this origin allows malicious code executed in such contexts to access authenticated responses containing sensitive data.

## Exploitation Steps

1. Identify the injection point The `/accountDetails` endpoint exposes sensitive data and supports credentialed CORS requests.
2. Test for vulnerability The Origin header is set to `null`, and the server explicitly allows it.
3. Craft the payload and execute the attack A sandboxed iframe with `srcdoc` is used to generate a `null` origin context. The embedded script performs a credentialed request to `/accountDetails` and exfiltrates the response.
4. Verify successful exploitation The exploit server log records the administrator’s API key extracted from the response.

## AppSec Perspective

### **What the underlying code might be**

A simplified backend implementation might look like:

```python
origin = request.headers.get("Origin")
if origin == "null":
    response.headers["Access-Control-Allow-Origin"] = "null"
response.headers["Access-Control-Allow-Credentials"] = "true"
```

### **Security issues enabling exploitation**

- Trusting the `null` origin
- Credentialed cross-origin requests enabled for untrusted origins
- Exposure of sensitive data via CORS-accessible endpoints

### **How to fix it**

- Implement a strict allowlist of trusted origins
- Explicitly reject the `null` origin
- Disable `Access-Control-Allow-Credentials` unless strictly required
- Restrict sensitive endpoints from cross-origin access

## Key Takeaways

### Attacker perspective

- `null` origin contexts can bypass weak CORS validation (via iframes)
- Misconfigured CORS enables authenticated data exfiltration
- Credentialed requests significantly increase impact severity

### AppSec (defender) perspective

- The `null` origin must never be trusted
- CORS policies must follow least-privilege principles
- Sensitive endpoints should not be exposed to cross-origin reads

## References

- https://portswigger.net/web-security/cors
- https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny
- https://cheatsheetseries.owasp.org/cheatsheets/CORS_Configuration_Cheat_Sheet.html
- https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS